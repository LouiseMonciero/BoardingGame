const server_url="https://boarding-games-server.vercel.app";document.addEventListener("alpine:init",(()=>{Alpine.store("gameCache",{games:[],lastUpdated:null,init(){const e=localStorage.getItem("gameCache");if(e)try{const a=JSON.parse(e);this.games=a.games||[],this.lastUpdated=a.lastUpdated||null}catch(e){console.error("Error parsing cache",e),this.clear()}},isValid(){return this.games.length>0&&this.lastUpdated&&Date.now()-this.lastUpdated<3e5},save(e){this.games=e,this.lastUpdated=Date.now(),localStorage.setItem("gameCache",JSON.stringify({games:this.games,lastUpdated:this.lastUpdated}))},clear(){this.games=[],this.lastUpdated=null,localStorage.removeItem("gameCache")}}),Alpine.store("gameCache").init(),Alpine.data("library",(()=>({minRank:1,maxRank:100,minPlayers:1,maxPlayers:10,minPlaytime:0,maxPlaytime:300,minYear:1900,maxYear:(new Date).getFullYear(),minRating:null,minAge:null,minReviews:null,searchTerm:"",selectedCategory:"",games:[],categories:[],isLoading:!1,usingCache:!1,async init(){await this.fetchCategories(),Alpine.store("gameCache").isValid()?(this.games=Alpine.store("gameCache").games,this.usingCache=!0,console.log("Utilisation des jeux en cache")):await this.fetchAllGames(),this.$nextTick((()=>{this.initSliders()}))},initSliders(){this.updateDualSlider(null,"minRank","maxRank","rank-slider","rank-bar"),this.updateDualSlider(null,"minPlayers","maxPlayers","players-slider","players-bar")},updateDualSlider(e,a,i,t,s){const r=e?e.target:null,n=a.includes("min")?this[a]:this[i],l=a.includes("max")?this[a]:this[i],h=document.getElementById(t),m=document.getElementById(s);if(r&&(a.includes("min")&&n>=l?(this[i]=n+1,this[i]>this.getMaxValue(a)&&(this[i]=this.getMaxValue(a))):a.includes("max")&&l<=n&&(this[i]=l-1,this[i]<this.getMinValue(a)&&(this[i]=this.getMinValue(a)))),h&&m){const e=a.includes("min")?this[a]:this[i],t=a.includes("max")?this[a]:this[i],s=this.getMaxValue(a),r=e/s,n=t/s,l=h.clientWidth-18,c=l*r+9,g=l*n+9-c;m.style.left=c+"px",m.style.width=g+"px"}e&&this.applyFilters()},getMaxValue:e=>({Rank:100,Players:10,Playtime:300,Year:(new Date).getFullYear()}[e.replace(/min|max/,"")]),getMinValue:e=>({Rank:1,Players:1,Playtime:0,Year:1900}[e.replace(/min|max/,"")]),async fetchAllGames(){this.isLoading=!0,this.usingCache=!1;try{const e=await fetch(`${server_url}/api/games`);if(!e.ok)throw new Error("Erreur lors de la récupération des jeux");const a=await e.json();Alpine.store("gameCache").save(a),this.games=a}catch(e){console.error("Erreur:",e),Alpine.store("gameCache").games.length>0?(this.games=Alpine.store("gameCache").games,this.usingCache=!0,console.log("Fallback au cache après erreur")):alert("Impossible de charger les jeux")}finally{this.isLoading=!1}},async fetchCategories(){try{const e=await fetch(`${server_url}/api/categories`);if(!e.ok)throw new Error("Erreur de chargement des catégories");this.categories=await e.json()}catch(e){console.error("Erreur:",e)}},async applyFilters(){if(!this.hasActiveFilters()&&Alpine.store("gameCache").isValid())return this.games=Alpine.store("gameCache").games,void(this.usingCache=!0);this.isLoading=!0,this.usingCache=!1;try{const e=new URLSearchParams;this.searchTerm&&e.append("search_term",this.searchTerm.trim()),this.selectedCategory&&e.append("category",this.selectedCategory),this.minRating&&e.append("min_rating",this.minRating),this.minRank&&e.append("min_rank",this.minRank),this.maxRank&&e.append("max_rank",this.maxRank),this.minPlayers&&e.append("min_players",this.minPlayers),this.maxPlayers&&e.append("max_players",this.maxPlayers),this.minPlaytime&&e.append("min_playtime",this.minPlaytime),this.maxPlaytime&&e.append("max_playtime",this.maxPlaytime),this.minAge&&e.append("min_age",this.minAge),this.minYear&&e.append("min_year",this.minYear),this.maxYear&&e.append("max_year",this.maxYear),this.minReviews&&e.append("min_reviews",this.minReviews);const a=`${server_url}/api/games/search?${e.toString()}`;console.log("Request URL:",a);const i=await fetch(a);if(!i.ok){const e=await i.json().catch((()=>null));throw console.error("Error details:",e),new Error(`Server error: ${i.status}`)}this.games=await i.json(),this.hasActiveFilters()||Alpine.store("gameCache").save(this.games)}catch(e){console.error("Full error:",e),Alpine.store("gameCache").games.length>0?(this.games=Alpine.store("gameCache").games,this.usingCache=!0,console.log("Fallback au cache après erreur de recherche")):alert(`Erreur lors de la recherche: ${e.message}`)}finally{this.isLoading=!1}},hasActiveFilters(){return this.searchTerm||this.selectedCategory||this.minRating||1!==this.minRank||100!==this.maxRank||1!==this.minPlayers||10!==this.maxPlayers||0!==this.minPlaytime||300!==this.maxPlaytime||this.minAge||1900!==this.minYear||this.maxYear!==(new Date).getFullYear()||this.minReviews},resetFilters(){this.searchTerm="",this.selectedCategory="",this.minRating=null,this.minRank=1,this.maxRank=100,this.minPlayers=1,this.maxPlayers=10,this.minPlaytime=0,this.maxPlaytime=300,this.minAge=null,this.minYear=1900,this.maxYear=(new Date).getFullYear(),this.minReviews=null,Alpine.store("gameCache").games.length>0?(this.games=Alpine.store("gameCache").games,this.usingCache=!0):this.fetchAllGames(),this.$nextTick((()=>this.initSliders()))},formatRating:e=>Math.round(e||0)})))}));